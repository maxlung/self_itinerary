---
import { getCollection, getEntry, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ItineraryCard from '../../components/ItineraryCard.astro';
import QRShare from '../../components/QRShare.astro';
import { marked } from 'marked';

export async function getStaticPaths() {
  const itineraries = await getCollection('itinerary');
  return itineraries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// ç›´æ¥ä»Markdownä¸­è§£æè¡Œç¨‹é¡¹ç›®
function parseMarkdownContent(entry: CollectionEntry<'itinerary'>) {
  const rawContent = entry.body;
  const scheduleItems = [];
  
  // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…Markdownä¸­çš„è¡Œç¨‹é¡¹ç›® - æ”¹è¿›ç‰ˆæœ¬
  const schedulePattern = /### (\d{1,2}:\d{2}) (.*?)\n([\s\S]*?)(?=\n---|\n###|\n##|$)/gs;
  
  let match;
  while ((match = schedulePattern.exec(rawContent)) !== null) {
    const time = match[1].trim();
    const place = match[2].trim();
    
    // æå–æ‰€æœ‰å†…å®¹
    const detailsText = match[3].trim();
    
    // æå–æè¿°ï¼ˆç¬¬ä¸€è¡Œæ–‡æœ¬ï¼‰
    const descriptionMatch = detailsText.match(/>\s*(.*?)(?=\s*\n|$)/);
    const description = descriptionMatch ? descriptionMatch[1].trim() : '';
    
    // å•ç‹¬æå–åœ°å›¾é“¾æ¥
    const mapMatch = detailsText.match(/ğŸ“\s*`([^`]+)`/);
    const mapUrl = mapMatch ? mapMatch[1] : '';
    
    // å•ç‹¬æå–å›¾ç‰‡é“¾æ¥
    const imageMatch = detailsText.match(/ğŸ–¼ï¸\s*`([^`]+)`/);
    const imageUrl = imageMatch ? imageMatch[1] : '';
    
    // è°ƒè¯•
    // console.log("åŸå§‹æ–‡æœ¬:", detailsText);
    // console.log("æè¿°åŒ¹é…:", descriptionMatch);
    // console.log("åœ°å›¾åŒ¹é…:", mapMatch);
    // console.log("å›¾ç‰‡åŒ¹é…:", imageMatch);
    // console.log("è§£æç»“æœ:", {time, title: place, description, mapUrl, imageUrl});
    
    scheduleItems.push({
      time,
      title: place,
      description,
      mapUrl,
      imageUrl
    });
  }
  
  return scheduleItems;
}

// è§£æè¡Œç¨‹é¡¹ç›®
const scheduleItems = parseMarkdownContent(entry);

// è·å–å½“å‰é¡µé¢URL
const currentPath = `/itinerary/${entry.slug}`;
---

<Layout title={entry.data.title}>
  <article class="max-w-4xl mx-auto">
    <header class="mb-8">
      <div class="relative h-64 md:h-80 rounded-lg overflow-hidden mb-6">
        <img 
          src={entry.data.cover} 
          alt={entry.data.title} 
          class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        <div class="absolute bottom-0 left-0 p-6 text-white">
          <h1 class="text-2xl md:text-4xl font-bold mb-2">{entry.data.title}</h1>
          <p class="text-rice">{entry.data.date}</p>
        </div>
      </div>
    </header>

    <div class="itinerary-cards">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <span class="mr-2">ğŸ•˜</span> è¡Œç¨‹
      </h2>
      
      <!-- æ¡Œé¢ç‰ˆï¼šä¸¤æ å¸ƒå±€ -->
      <div class="hidden md:grid md:grid-cols-[150px_1fr] md:gap-6">
        {scheduleItems.map(item => (
          <>
            <div class="time-column pt-2">
              <div class="bg-accent text-white p-2 rounded-md text-center font-bold">
                {item.time}
              </div>
            </div>
            <div class="content-column">
              <ItineraryCard
                time={item.time}
                title={item.title}
                description={item.description}
                mapUrl={item.mapUrl}
                imageUrl={item.imageUrl}
              />
            </div>
          </>
        ))}
      </div>
      
      <!-- æ‰‹æœºç‰ˆï¼šå•æ å¸ƒå±€ -->
      <div class="md:hidden space-y-6">
        {scheduleItems.map(item => (
          <ItineraryCard
            time={item.time}
            title={item.title}
            description={item.description}
            mapUrl={item.mapUrl}
            imageUrl={item.imageUrl}
          />
        ))}
      </div>
    </div>

    <QRShare url={currentPath} title="æ‰«ç åˆ†äº«æ­¤è¡Œç¨‹" />
  </article>
</Layout>

<style>
  /* ä¸ºæ—¶é—´çº¿æ·»åŠ å‚ç›´è¿æ¥çº¿ */
  @media (min-width: 768px) {
    .time-column {
      position: relative;
    }
    .time-column::after {
      content: '';
      position: absolute;
      top: 40px;
      bottom: 0;
      left: 50%;
      width: 2px;
      background-color: theme('colors.accent-light');
    }
    .time-column:last-child::after {
      display: none;
    }
  }
</style> 